@page "/billiard"
@inject IJSRuntime JS
@implements IAsyncDisposable
@using Microsoft.JSInterop

<PageTitle>Billiard</PageTitle>

<section class="billiard-page">
    <header class="billiard-header">
        <div>
            <h1>Billiard</h1>
            <p>Ziehe mit der Maus vom weißen Ball weg, lasse los und beobachte den Stoß – versenke alle Kugeln so effizient wie möglich.</p>
        </div>
        <div class="billiard-stats">
            <div>
                <span>Kugeln übrig</span>
                <strong>@_remainingBalls</strong>
            </div>
            <div>
                <span>Stöße</span>
                <strong>@_shots</strong>
            </div>
        </div>
    </header>

    <div class="billiard-table">
        <canvas width="720" height="360" @ref="_canvasRef"></canvas>
        @if (_victory)
        {
            <div class="billiard-message">
                <h2>Alle Kugeln versenkt!</h2>
                <p>Fantastischer Stoß! Starte eine neue Runde und knacke deine Bestzeit.</p>
            </div>
        }
    </div>

    <div class="billiard-actions">
        <div class="billiard-status">
            <span>@StatusTitle</span>
            <p>@StatusDescription</p>
        </div>
        <button class="arcade-btn" @onclick="ResetAsync">Neu aufstellen</button>
    </div>
</section>

@code {
    private ElementReference _canvasRef;
    private DotNetObjectReference<Billiard>? _objRef;
    private IJSObjectReference? _module;
    private int _remainingBalls;
    private int _shots;
    private bool _victory;
    private bool _canShoot = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./scripts/billiard.js");
            _objRef = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("init", _canvasRef, _objRef);
        }
    }

    private async Task ResetAsync()
    {
        if (_module is null)
        {
            return;
        }

        await _module.InvokeVoidAsync("reset", _canvasRef);
        _victory = false;
        _canShoot = true;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task UpdateStatus(int remaining, int shots, bool victory, bool ready)
    {
        _remainingBalls = remaining;
        _shots = shots;
        _victory = victory;
        _canShoot = ready && !victory;
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("dispose", _canvasRef);
            }
            catch
            {
            }
            await _module.DisposeAsync();
            _module = null;
        }

        if (_objRef is not null)
        {
            _objRef.Dispose();
            _objRef = null;
        }
    }

    private string StatusTitle => _victory
        ? "Runde gewonnen"
        : _canShoot
            ? "Bereit für den Stoß"
            : "Kugeln in Bewegung";

    private string StatusDescription => _victory
        ? "Alle Objektkugeln sind versenkt – starte eine neue Partie."
        : _canShoot
            ? "Ziele, indem du vom weißen Ball wegziehst. Je länger der Zug, desto stärker der Stoß."
            : "Bitte warte, bis alle Kugeln zur Ruhe gekommen sind.";
}
