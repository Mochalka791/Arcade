@page "/anmelden"
@using Arcade.Data.Dtos
@using Microsoft.AspNetCore.Components.Authorization
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav

<div class="auth">
    <section class="auth__card">
        <h1>Anmelden</h1>
        <p>Log dich ein, um Scores zu speichern.</p>

        <div class="auth__form">
            <label>
                Username
                <input placeholder="Nickname" @bind="loginUser" />
            </label>

            <label>
                Passwort
                <input type="password" placeholder="Passwort" @bind="loginPass" />
            </label>

            <div class="auth__actions">
                <button class="auth__submit" @onclick="DoLogin" disabled="@isBusy">
                    Login
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(loginError))
            {
                <p class="auth__error">@loginError</p>
            }

            <p class="auth__hint">
                Noch keinen Account?
                <a href="/registrieren">Account erstellen</a>
            </p>
        </div>
    </section>
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    string loginUser = "", loginPass = "", loginError = "";
    bool isBusy = false;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateTask!;
        if (state.User.Identity?.IsAuthenticated == true)
        {
            Nav.NavigateTo("/", forceLoad: true);
        }
    }

    async Task DoLogin()
    {
        isBusy = true;
        loginError = "";

        try
        {
            var http = HttpFactory.CreateClient();
            var dto = new LoginDto { Username = loginUser, Password = loginPass };

            var resp = await http.PostAsJsonAsync("/api/auth/login", dto);

            if (!resp.IsSuccessStatusCode)
            {
                var msg = await resp.Content.ReadFromJsonAsync<Dictionary<string, string>>();
                loginError = msg?.GetValueOrDefault("message") ?? "Login fehlgeschlagen.";
                return;
            }

            Nav.NavigateTo("/", forceLoad: true);
        }
        finally
        {
            isBusy = false;
        }
    }
}
