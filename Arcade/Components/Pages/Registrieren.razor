@page "/registrieren"
@rendermode InteractiveServer
@using Arcade.Data.Dtos
@using System.Net.Http.Json
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav

<!-- Vollbild-Hintergrund -->
<div class="auth-bg"></div>

<div class="auth">
    <section class="auth__card">
        <header class="auth__header">
            <h1 class="auth__title">Registrieren</h1>
            <p class="auth__subtitle">Erstelle deinen neuen Arcade-Account.</p>
        </header>

        <div class="auth__form">
            <label class="auth__field">
                <span class="auth__label">Username</span>
                <input class="auth__input"
                       type="text"
                       placeholder="Nickname"
                       @bind="regUser" />
            </label>

            <label class="auth__field">
                <span class="auth__label">E-Mail (optional)</span>
                <input class="auth__input"
                       type="email"
                       placeholder="E-Mail-Adresse"
                       @bind="regEmail" />
            </label>

            <label class="auth__field">
                <span class="auth__label">Passwort</span>
                <input class="auth__input"
                       type="password"
                       placeholder="Passwort"
                       @bind="regPass" />
            </label>

            <div class="auth__actions">
                <button class="auth__submit @(isBusy ? "auth__submit--busy" : null)"
                        @onclick="DoRegister"
                        disabled="@isBusy">
                    @(isBusy ? "Wird erstellt..." : "Account erstellen")
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(regError))
            {
                <p class="auth__error">@regError</p>
            }

            @if (regOk)
            {
                <p class="auth__ok">Registriert! Du wirst zur Anmeldung weitergeleitet...</p>
            }

            <p class="auth__hint">
                Schon einen Account?
                <a href="/anmelden">Zur Anmeldung</a>
            </p>
        </div>
    </section>
</div>

@code {
    private string regUser = "";
    private string regPass = "";
    private string regEmail = "";
    private string regError = "";
    private bool regOk = false;
    private bool isBusy = false;

    private async Task DoRegister()
    {
        isBusy = true;
        regError = "";
        regOk = false;

        try
        {
            var http = HttpFactory.CreateClient();
            http.BaseAddress = new Uri(Nav.BaseUri);

            var dto = new RegisterDto
            {
                Username = regUser,
                Email = string.IsNullOrWhiteSpace(regEmail) ? null : regEmail,
                Password = regPass
            };

            var resp = await http.PostAsJsonAsync("api/auth/register", dto);
            var raw = await resp.Content.ReadAsStringAsync();

            if (!resp.IsSuccessStatusCode)
            {
                regError = $"Fehler: {(int)resp.StatusCode} {resp.StatusCode}";
                return;
            }

            regOk = true;
            await Task.Delay(1200);
            Nav.NavigateTo("/anmelden");
        }
        catch (Exception ex)
        {
            regError = $"Fehler bei der Registrierung: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }
}
