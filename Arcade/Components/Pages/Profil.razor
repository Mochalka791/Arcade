@page "/profil"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@layout Arcade.Components.Layout.MainLayout
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Arcade.Data
@using Arcade.Data.Entities

@inject ArcadeDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
<div class="profil">
    <div class="profil__header">
        <p class="profil__greeting">Hi <span class="profil__username">@UserName</span> 👋</p>
    </div>

    <div class="profil__card">
        <div class="profil__avatar-section">
            <div class="profil__avatar-wrapper">
                @if (!string.IsNullOrEmpty(AvatarUrl))
                {
                    <img src="@AvatarUrl" alt="Avatar" class="profil__avatar" />
                }
                else
                {
                    <div class="profil__avatar-placeholder">
                        @(UserName.Length > 0 ? UserName[..1].ToUpper() : "?")
                    </div>
                }
                <label class="profil__avatar-upload" title="Avatar ändern">
                    <input type="file" class="profil__avatar-input" accept="image/*" />
                </label>
            </div>
        </div>

        <div class="profil__info">
            <div class="profil__info-item">
                <span class="profil__info-label">Benutzername</span>
                <span class="profil__info-value">@UserName</span>
            </div>
            <div class="profil__info-item">
                <span class="profil__info-label">Registriert seit</span>
                <span class="profil__info-value">@RegistrationDateDisplay</span>
            </div>
            <div class="profil__info-item">
                <span class="profil__info-label">Tage dabei</span>
                <span class="profil__info-value">@DaysSinceRegistration Tage</span>
            </div>
        </div>
    </div>

    <div class="profil__card">
        <h2 class="profil__section-title">Persönliche Rekorde</h2>

        <div class="profil__scores">
            <!-- Snake -->
            <div class="profil__score-card">
                <div class="profil__score-game">🐍 Snake</div>
                <div class="profil__score-stats">
                    <div class="profil__score-item">
                        <span class="profil__score-label">Highscore</span>
                        <span class="profil__score-value profil__score-value--highlight">
                            @(_snakeHighScore?.ToString() ?? "0")
                        </span>
                    </div>
                    <div class="profil__score-item">
                        <span class="profil__score-label">Spiele gespielt</span>
                        <span class="profil__score-value">
                            @(_snakeGamesPlayed?.ToString() ?? "0")
                        </span>
                    </div>
                    <div class="profil__score-item">
                        <span class="profil__score-label">Ø Punktzahl</span>
                        <span class="profil__score-value">
                            @(_snakeAverageScore.HasValue? _snakeAverageScore.Value.ToString("0.0") : "0")
                        </span>
                    </div>
                </div>
            </div>

            <!-- Tetris -->
            <div class="profil__score-card">
                <div class="profil__score-game">🧱 Tetris</div>
                <div class="profil__score-stats">
                    <div class="profil__score-item">
                        <span class="profil__score-label">Highscore</span>
                        <span class="profil__score-value profil__score-value--highlight">
                            @(_tetrisHighScore?.ToString() ?? "0")
                        </span>
                    </div>
                    <div class="profil__score-item">
                        <span class="profil__score-label">Spiele gespielt</span>
                        <span class="profil__score-value">
                            @(_tetrisGamesPlayed?.ToString() ?? "0")
                        </span>
                    </div>
                    <div class="profil__score-item">
                        <span class="profil__score-label">Max. Level</span>
                        <span class="profil__score-value">
                            @(_tetrisMaxLevel?.ToString() ?? "0")
                        </span>
                    </div>
                </div>
            </div>

            <div class="profil__score-card">
                <div class="profil__score-game">🎮 Spiel 3</div>
                <div class="profil__empty">
                    Noch keine Rekorde
                </div>
            </div>

            <div class="profil__score-card">
                <div class="profil__score-game">🎮 Spiel 4</div>
                <div class="profil__empty">
                    Noch keine Rekorde
                </div>
            </div>

            <div class="profil__score-card">
                <div class="profil__score-game">🎮 Spiel 5</div>
                <div class="profil__empty">
                    Noch keine Rekorde
                </div>
            </div>

            <div class="profil__score-card">
                <div class="profil__score-game">🎮 Spiel 6</div>
                <div class="profil__empty">
                    Noch keine Rekorde
                </div>
            </div>
        </div>
    </div>

    <div class="profil__actions">
        <a href="/spiele" class="profil__button profil__button--primary">Zu den Spielen</a>
        <a href="/abmelden" class="profil__button profil__button--secondary">Logout</a>
    </div>
</div>

@code {
    private string UserName = "Spieler";
    private string? AvatarUrl;
    private DateTime? RegistrationDate;
    private string RegistrationDateDisplay = "-";
    private int DaysSinceRegistration = 0;

    private int? _snakeHighScore;
    private int? _snakeGamesPlayed;
    private decimal? _snakeAverageScore;

    private int? _tetrisHighScore;
    private int? _tetrisGamesPlayed;
    private int? _tetrisMaxLevel;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfoAsync();
        await LoadSnakeStatsAsync();
        await LoadTetrisStatsAsync();
    }

    // User laden (Name, Avatar, Registrierungsdatum)
    private async Task LoadUserInfoAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity is not { IsAuthenticated: true })
            return;

        UserName = user.Identity!.Name ?? "Spieler";

        var dbUser = await Db.Users
            .FirstOrDefaultAsync(u => u.Username == UserName);

        if (dbUser == null)
            return;

        // AvatarUrl = dbUser.AvatarUrl;

        if (dbUser.CreatedAt != default)
        {
            RegistrationDate = dbUser.CreatedAt;
            RegistrationDateDisplay = RegistrationDate?.ToString("dd.MM.yyyy") ?? "-";
            DaysSinceRegistration = (int)(DateTime.Now - RegistrationDate!.Value).TotalDays;
        }
    }

    // Snake Stats laden
    private async Task LoadSnakeStatsAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity is not { IsAuthenticated: true })
            return;

        int? userId = await ResolveUserIdAsync(user);

        if (userId is null)
            return;

        var stats = await Db.SnakeStats
            .FirstOrDefaultAsync(s => s.UserId == userId);

        if (stats != null)
        {
            _snakeHighScore = stats.HighScore;
            _snakeGamesPlayed = stats.GamesPlayed;
            _snakeAverageScore = stats.AverageScore;
        }
    }

    // Tetris Stats laden
    private async Task LoadTetrisStatsAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity is not { IsAuthenticated: true })
            return;

        int? userId = await ResolveUserIdAsync(user);

        if (userId is null)
            return;

        var stats = await Db.TetrisStats
            .FirstOrDefaultAsync(t => t.UserId == userId);

        if (stats != null)
        {
            _tetrisHighScore = stats.HighScore;
            _tetrisGamesPlayed = stats.GamesPlayed;
            _tetrisMaxLevel = stats.MaxLevel;
        }
    }

    // UserId bestimmen (Claim → Fallback Username)
    private async Task<int?> ResolveUserIdAsync(ClaimsPrincipal principal)
    {
        var idClaim =
            principal.FindFirst(ClaimTypes.NameIdentifier) ??
            principal.FindFirst("userId") ??
            principal.FindFirst("sub") ??
            principal.FindFirst("id");

        if (idClaim != null && int.TryParse(idClaim.Value, out var parsedId))
            return parsedId;

        var username = principal.Identity?.Name;

        if (string.IsNullOrWhiteSpace(username))
            return null;

        var dbUser = await Db.Users
            .FirstOrDefaultAsync(u => u.Username == username);

        return dbUser?.Id;
    }
}