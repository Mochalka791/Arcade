@page "/minesweeper"
@layout Arcade.Components.Layout.MainLayout
@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using System.Diagnostics
@using Arcade.Games.Minesweeper

<PageTitle>Minesweeper</PageTitle>

<section class="minesweeper-page">
    <header class="minesweeper-header">
        <h1 class="minesweeper-title">Minesweeper</h1>

        <div class="minesweeper-controls">
            <div class="ms-difficulty">
                <button class="@GetDifficultyClass(DifficultyLevel.Beginner)"
                        @onclick="@(() => ChangeDifficulty(DifficultyLevel.Beginner))">
                    Beginner
                </button>
                <button class="@GetDifficultyClass(DifficultyLevel.Intermediate)"
                        @onclick="@(() => ChangeDifficulty(DifficultyLevel.Intermediate))">
                    Intermediate
                </button>
                <button class="@GetDifficultyClass(DifficultyLevel.Expert)"
                        @onclick="@(() => ChangeDifficulty(DifficultyLevel.Expert))">
                    Expert
                </button>
            </div>

            <div class="ms-hud">
                <div class="ms-counter">
                    <span class="label">Mines</span>
                    <span class="value">@MinesLeft</span>
                </div>

                <button class="ms-face"
                        title="New game"
                        @onclick="StartNewGame">
                    @GetFaceEmoji()
                </button>

                <div class="ms-counter">
                    <span class="label">Time</span>
                    <span class="value">@TimeSeconds.ToString("0.0")</span>
                </div>

                <button class="ms-dev-btn" @onclick="ForceWin">
                    Test Win
                </button>
            </div>
        </div>
    </header>

    <div class="minesweeper-main">
        <div class="ms-board-wrapper">
            @if (_engine is null)
            {
                <div class="ms-empty">Loading…</div>
            }
            else
            {
                <div class="ms-board"
                     style="--cols:@_engine.Width; --rows:@_engine.Height;"
                     oncontextmenu="return false;">
                    @for (var y = 0; y < _engine.Height; y++)
                    {
                        for (var x = 0; x < _engine.Width; x++)
                        {
                            var cell = _engine.Grid[x, y];

                            <button class="@GetCellClass(cell)"
                                    @onmousedown="@(e => HandleMouseDown(e, cell))">
                                @RenderCellContent(cell)
                            </button>
                        }
                    }
                </div>
            }
        </div>

        <aside class="ms-results-panel">
            <h2 class="ms-results-title">
                @if (_state == GameState.Won)
                {
                    <span>🎉 Congratulations!</span>
                }
                else if (_state == GameState.Lost)
                {
                    <span>💥 Boom!</span>
                }
                else
                {
                    <span>🧩 Ready to play</span>
                }
            </h2>

            <p class="ms-rank-line">
               @*  Rank: <strong>@Rank</strong> *@
            </p>

            @if (_state == GameState.Won)
            {
                <p class="ms-win-text">
                    You cleared the field on <strong>@_difficulty</strong>!
                </p>
            }
            else if (_state == GameState.Lost)
            {
                <p class="ms-lose-text">
                    You hit a mine. Try again!
                </p>
            }
            else
            {
                <p class="ms-info-text">
                    Left click to reveal, right click to flag.
                </p>
            }

            <ul class="ms-stats">
                <li>
                    <span>Time:</span>
                    <span>@TimeSeconds.ToString("0.0") sec</span>
                </li>
                <li>
                    <span>3BV:</span>
                    <span>@(ThreeBV > 0 ? ThreeBV.ToString() : "–")</span>
                </li>
                <li>
                    <span>3BV/s:</span>
                    <span>
                        @(ThreeBVPerSecond > 0
                                                ? ThreeBVPerSecond.ToString("0.0")
                                                : "–")
                    </span>
                </li>
                <li>
                    <span>Clicks:</span>
                    <span>@_clicksTotal</span>
                </li>
                <li>
                    <span>Efficiency:</span>
                    <span>
                        @(EfficiencyPercent > 0
                                                ? EfficiencyPercent.ToString("0") + "%"
                                                : "–")
                    </span>
                </li>
            </ul>

            <div class="ms-rewards">
             @*    <p>⭐ Experience: +@Xp</p>
                <p>🟡 Minecoins: +@Coins</p>
                <p>🏆 Trophies: +@Trophies</p> *@
            </div>

            <button class="ms-newgame-btn" @onclick="StartNewGame">
                New Game
            </button>
        </aside>
    </div>
</section>

@code
{
    private enum GameState
    {
        Ready,
        Playing,
        Won,
        Lost
    }

    private enum DifficultyLevel
    {
        Beginner,
        Intermediate,
        Expert
    }

    private MinesweeperEngine? _engine;
    private DifficultyLevel _difficulty = DifficultyLevel.Beginner;
    private GameState _state = GameState.Ready;

    private readonly Stopwatch _stopwatch = new();
    private int _clicksTotal;

    private double TimeSeconds => _stopwatch.Elapsed.TotalSeconds;

    private int MinesLeft
        => _engine is null
            ? 0
            : Math.Max(0,
                _engine.Mines - _engine.Grid.Cast<Cell>().Count(c => c.IsFlagged));

    private int ThreeBV
        => _engine is null ? 0 : MinesweeperStats.Calculate3BV(_engine);

    private double ThreeBVPerSecond
        => MinesweeperStats.Calculate3BVPerSecond(ThreeBV, TimeSeconds);

    private double EfficiencyPercent
        => MinesweeperStats.CalculateEfficiency(ThreeBV, _clicksTotal);

    // private string Rank
    //     => MinesweeperStats.GetRank(_state == GameState.Won);

    // private int Xp
    //     => MinesweeperStats.GetXP(_state == GameState.Won);

    // private int Coins
    //     => MinesweeperStats.GetCoins(_state == GameState.Won);

    // private int Trophies
    //     => MinesweeperStats.GetTrophies(_state == GameState.Won);

    protected override void OnInitialized()
    {
        CreateEngine();
    }

    private void CreateEngine()
    {
        (int w, int h, int m) preset = _difficulty switch
        {
            DifficultyLevel.Beginner => MinesweeperDifficulty.Beginner,
            DifficultyLevel.Intermediate => MinesweeperDifficulty.Intermediate,
            DifficultyLevel.Expert => MinesweeperDifficulty.Expert,
            _ => MinesweeperDifficulty.Beginner
        };

        _engine = new MinesweeperEngine(preset.w, preset.h, preset.m);
        _clicksTotal = 0;
        _state = GameState.Ready;
        _stopwatch.Reset();
    }
    private System.Timers.Timer? _timer;
    private void StartNewGame()
    {
        CreateEngine();
        _stopwatch.Reset();
        _timer?.Stop();
        _timer = new System.Timers.Timer(100); 
        _timer.Elapsed += (_, _) =>
        {
            if (_state == GameState.Playing)
                InvokeAsync(StateHasChanged);
        };
        _timer.Start();
    }

    private void ChangeDifficulty(DifficultyLevel diff)
    {
        if (_difficulty == diff)
        {
            return;
        }

        _difficulty = diff;
        CreateEngine();
    }

    private void HandleMouseDown(MouseEventArgs e, Cell cell)
    {
        if (_engine is null)
        {
            return;
        }

        if (_state == GameState.Lost || _state == GameState.Won)
        {
            return;
        }

        if (_state == GameState.Ready)
        {
            _state = GameState.Playing;
            _stopwatch.Start();
        }

        if (e.Button == 0)
        {
            _clicksTotal++;
            _engine.Reveal(cell);
        }
        else if (e.Button == 2)
        {
            _clicksTotal++;
            _engine.ToggleFlag(cell);
        }

        if (_engine.IsGameOver)
        {
            _state = _engine.IsWin ? GameState.Won : GameState.Lost;
            _stopwatch.Stop();
            _timer?.Stop();
        }

    }

    private void ForceWin()
    {
        if (_engine is null)
        {
            return;
        }

        _engine.ForceWin();
        _state = GameState.Won;

        if (!_stopwatch.IsRunning && TimeSeconds == 0)
        {
            _stopwatch.Start();
        }

        _stopwatch.Stop();
    }

    private string GetFaceEmoji()
        => _state switch
        {
            GameState.Ready => "🙂",
            GameState.Playing => "😐",
            GameState.Won => "😎",
            GameState.Lost => "☠️",
            _ => "🙂"
        };

    private string GetDifficultyClass(DifficultyLevel level)
    {
        var baseClass = "ms-diff-btn";
        return level == _difficulty
            ? $"{baseClass} ms-diff-btn--active"
            : baseClass;
    }

    private RenderFragment RenderCellContent(Cell cell) => builder =>
    {
        if (!cell.IsRevealed)
        {
            if (cell.IsFlagged)
            {
                builder.AddContent(0, "🚩");
            }

            return;
        }

        if (cell.IsMine)
        {
            builder.AddContent(1, "💣");
            return;
        }

        if (cell.Adjacent > 0)
        {
            builder.OpenElement(2, "span");
            builder.AddAttribute(3, "class", $"ms-num ms-num-{cell.Adjacent}");
            builder.AddContent(4, cell.Adjacent);
            builder.CloseElement();
        }
    };

    private string GetCellClass(Cell cell)
    {
        var classes = "ms-cell";

        if (cell.IsRevealed)
        {
            classes += " ms-cell--revealed";

            if (cell.IsMine)
            {
                classes += " ms-cell--mine";
            }
        }

        if (cell.IsFlagged && !cell.IsRevealed)
        {
            classes += " ms-cell--flagged";
        }

        return classes;
    }
}
