@page "/towerdef"

@layout Arcade.Components.Layout.MainLayout
@implements IDisposable
@inject IJSRuntime JS

@using Microsoft.JSInterop
@using Arcade.Games.TowerDefense.Core
@using Arcade.Games.TowerDef.Core
@using Arcade.Games.TowerDef.Enemies
@using Arcade.Games.TowerDef.Towers
@using Arcade.Games.TowerDef.Combat
@using Arcade.Games.TowerDef.Pathing
@using Arcade.Games.TowerDef.Rendering
@using Arcade.Games.TowerDef.Services

@rendermode Microsoft.AspNetCore.Components.Web.RenderMode.InteractiveServer

<div class="tower-defense-fullscreen">
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="stats-bar">
            <span>💰 @_state.Gold</span>
            <span>❤️ @_state.Lives</span>
            <span>🌊 Wave @_state.CurrentWave</span>
            <span>👹 @_enemies.Count</span>

            <button @onclick="_gameSpeed.Toggle">
                ⚡ x@_state.GameSpeed
            </button>
        </div>
    </div>

    <!-- GAME AREA -->
    <div class="game-area">
        <canvas id="gameCanvas"></canvas>

        <div class="side-panel">
            <h3>🔨 Türme</h3>

            @foreach (var type in Enum.GetValues<TowerType>())
            {
                <button @onclick="() => _input.SelectTower(type)">
                    @type (💰 @TowerUpgrades.GetBaseCost(type))
                </button>
            }

            <button class="start-wave-btn"
                    disabled="@_state.GameOver"
                    @onclick="StartWave">
                ▶️ Wave @_state.NextWave starten
            </button>

            @if (_towerInteraction.SelectedTower != null)
            {
                <div class="upgrade-panel">
                    <h4>🔧 Upgrade</h4>

                    <p>Level: @_towerInteraction.SelectedTower.Level</p>

                    @if (CanUpgradeSelectedTower)
                    {
                        <button @onclick="_towerInteraction.Upgrade">
                            ⬆️ Upgrade
                            (💰 @_towerInteraction.GetUpgradeCost(_towerInteraction.SelectedTower!))
                        </button>
                    }
                    else
                    {
                        <button disabled>
                            ⬆️ Upgrade
                            (💰 @_towerInteraction.GetUpgradeCost(_towerInteraction.SelectedTower!))
                        </button>
                    }

                    <button @onclick="_towerInteraction.Sell">
                        💸 Verkaufen
                        (💰 @_towerInteraction.GetSellValue(_towerInteraction.SelectedTower))
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    /* ================= CORE ================= */

    private readonly GameState _state = new();

    private readonly List<Enemy> _enemies = new();
    private readonly List<Tower> _towers = new();
    private readonly List<Projectile> _projectiles = new();

    private readonly List<PathPoint> _path = Path.CreateDefault();

    private EnemyFactory _enemyFactory = null!;
    private WaveSystem _waveSystem = null!;
    private GameLoop _gameLoop = null!;

    /* ================= SERVICES ================= */

    private InputService _input = null!;
    private GameSpeedService _gameSpeed = null!;
    private TowerInteractionService _towerInteraction = null!;

    /* ================= RUNTIME ================= */

    private Timer? _timer;
    private CancellationTokenSource _waveCts = new();

    private bool _jsInitialized;
    private DotNetObjectReference<TowerDef>? _dotNetRef;

    /* ================= LIFECYCLE ================= */

    protected override Task OnInitializedAsync()
    {
        var pathSelector = new PathSelector();

        _enemyFactory = new EnemyFactory(pathSelector);
        _waveSystem = new WaveSystem(_path, _enemyFactory);

        _gameLoop = new GameLoop(
            _state,
            _path,
            _enemies,
            _towers,
            _projectiles
        );

        _input = new InputService(_state, _towers, _path);
        _gameSpeed = new GameSpeedService(_state);
        _towerInteraction = new TowerInteractionService(_state, _towers);

        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        // JS-Interop darf erst hier passieren
        _dotNetRef = DotNetObjectReference.Create(this);

        await JS.InvokeVoidAsync(
            "towerDefense.init",
            _dotNetRef
        );

        _jsInitialized = true;

        // GameLoop erst nach JS-Init starten
        _timer = new Timer(_ =>
        {
            InvokeAsync(GameTick);
        }, null, 100, 16);
    }

    /* ================= GAME LOOP ================= */

    private async Task GameTick()
    {
        if (!_jsInitialized)
            return;

        _gameLoop.Tick(0.016f * _state.GameSpeed);

        var renderData = RenderDataMapper.Map(
            _path,
            _enemies,
            _towers,
            _projectiles
        );

        await JS.InvokeVoidAsync("towerDefense.render", renderData);
    }

    /* ================= GAME ACTIONS ================= */

    private Task StartWave()
    {
        if (_state.GameOver)
            return Task.CompletedTask;

        var wave = _state.NextWave++;
        _state.CurrentWave = wave;

        _ = _waveSystem.StartWaveAsync(
            wave,
            _state,
            _enemies,
            _waveCts.Token
        );

        return Task.CompletedTask;
    }

    [JSInvokable]
    public void OnCanvasClick(float x, float y)
    {
        var clickedTower = _towers
            .FirstOrDefault(t => Distance(t.X, t.Y, x, y) < 25);

        if (clickedTower != null)
        {
            _towerInteraction.SelectTower(clickedTower);
            return;
        }

        _input.TryPlaceTower(x, y);
    }

    /* ================= HELPERS ================= */

    private static float Distance(float x1, float y1, float x2, float y2)
    {
        var dx = x2 - x1;
        var dy = y2 - y1;
        return MathF.Sqrt(dx * dx + dy * dy);
    }

    private bool CanUpgradeSelectedTower =>
        _towerInteraction.SelectedTower != null &&
        _towerInteraction.CanUpgrade(_towerInteraction.SelectedTower);

    /* ================= CLEANUP ================= */

    public void Dispose()
    {
        _timer?.Dispose();
        _waveCts.Cancel();
        _dotNetRef?.Dispose();
    }
}